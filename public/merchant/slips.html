<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width,initial-scale=1'>
  <title>Merchant Slip Review v1</title>
  <link rel='stylesheet' href='assets/shop.css'>
  <style>
    .slip-image{max-width:100%;border-radius:12px;border:1px solid #e5e7eb}
    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .actions input{flex:1;min-width:220px;padding:8px;border:1px solid #d1d5db;border-radius:8px}
    .btn{padding:8px 12px;border:0;border-radius:8px;cursor:pointer}
    .btn-approve{background:#16a34a;color:#fff}
    .btn-reject{background:#dc2626;color:#fff}
  </style>
</head>
<body>
<div class='app'>
  <div id='header'></div>
  <div id='list'></div>
</div>
<div id='toast' class='toast'></div>

<script src='assets/api.js'></script>
<script src='assets/app.js'></script>
<script>
renderHeader('Slip Review v1');
if (requireAuth()) load();

function escapeHtml(v){return String(v||'').replace(/[&<>'"]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[s]))}
function normalizeImageUrl(url){
  if(!url) return '';
  if(url.startsWith('http://')||url.startsWith('https://')) return url;
  if(url.startsWith('/')) return shopSettings.getBaseUrl().replace(/\/$/,'') + url;
  return shopSettings.getBaseUrl().replace(/\/$/,'') + '/storage/' + url.replace(/^\/+/, '');
}

async function load(){
  list.innerHTML='<div class="loading">Loading...</div>';
  try{
    const d=await api.get('/api/merchant/payment-slips',{status:'pending'});
    const items=d.items||[];
    if(!items.length){list.innerHTML="<div class='card'>ไม่มีสลิปรอรีวิว</div>";return;}
    list.innerHTML=items.map(it=>{
      const img=normalizeImageUrl(it.image_url);
      return `<div class='card' id='slip-${it.id}'>
        <div class='row between'><b>${escapeHtml(it.order_no||('-'+it.order_id))}</b><span>${escapeHtml(it.slip_status)}</span></div>
        <div class='muted'>ยอดโอน: ${formatMoney(it.amount)} | Order: ${formatMoney(it.order_total)}</div>
        <div class='muted'>โอนเมื่อ: ${escapeHtml(it.transfer_at||'-')}</div>
        ${img?`<div style='margin-top:10px'><a href='${img}' target='_blank'><img class='slip-image' src='${img}' alt='slip ${it.id}'></a></div>`:""}
        <div class='actions'>
          <input id='note-${it.id}' type='text' placeholder='หมายเหตุ (จำเป็นเมื่อ reject)'>
          <button class='btn btn-approve' onclick='approveSlip(${it.id})'>Approve</button>
          <button class='btn btn-reject' onclick='rejectSlip(${it.id})'>Reject</button>
        </div>
      </div>`;
    }).join('');
  }catch(e){
    list.innerHTML=`<div class='error'>${escapeHtml(e.message)}</div>`;
  }
}

async function approveSlip(id){
  const note=(document.getElementById(`note-${id}`)?.value||'').trim();
  try{
    await api.post(`/api/merchant/payment-slips/${id}/approve`,{note:note||null});
    showToast('Approve สำเร็จ','success');
    document.getElementById(`slip-${id}`)?.remove();
  }catch(e){showToast(e.message,'error');}
}

async function rejectSlip(id){
  const note=(document.getElementById(`note-${id}`)?.value||'').trim();
  if(!note){showToast('กรอกหมายเหตุก่อน Reject','error');return;}
  try{
    await api.post(`/api/merchant/payment-slips/${id}/reject`,{note});
    showToast('Reject สำเร็จ','success');
    document.getElementById(`slip-${id}`)?.remove();
  }catch(e){showToast(e.message,'error');}
}
</script>
</body>
</html>
