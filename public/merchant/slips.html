<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width,initial-scale=1'>
  <title>Merchant Slip Review v1</title>
  <link rel='stylesheet' href='assets/shop.css'>
  <style>
    .slip-image{max-width:100%;border-radius:12px;border:1px solid #e5e7eb}
    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .actions input{flex:1;min-width:220px;padding:8px;border:1px solid #d1d5db;border-radius:8px}
    .btn{padding:8px 12px;border:0;border-radius:8px;cursor:pointer}
    .btn-approve{background:#16a34a;color:#fff}
    .btn-reject{background:#dc2626;color:#fff}
  </style>
</head>
<body>
<div class='app'>
  <div id='header'></div>
  <div id='list'></div>
</div>
<div id='toast' class='toast'></div>

<script src='assets/api.js'></script>
<script src='assets/app.js'></script>
<script>
renderHeader('Slip Review v1');
if (requireAuth()) load();

function normalizeImageUrl(url){
  if(!url) return '';
  if(url.startsWith('http://')||url.startsWith('https://')) return url;
  if(url.startsWith('/')) return shopSettings.getBaseUrl().replace(/\/$/,'') + url;
  return shopSettings.getBaseUrl().replace(/\/$/,'') + '/storage/' + url.replace(/^\/+/, '');
}

function clearNode(el){while(el.firstChild){el.removeChild(el.firstChild);}}

function createMuted(text){
  const div=document.createElement('div');
  div.className='muted';
  div.textContent=text;
  return div;
}

async function load(){
  clearNode(list);
  const loading=document.createElement('div');
  loading.className='loading';
  loading.textContent='Loading...';
  list.appendChild(loading);

  try{
    const d=await api.get('/api/merchant/payment-slips',{status:'all'});
    const items=d.items||[];
    clearNode(list);

    if(!items.length){
      const empty=document.createElement('div');
      empty.className='card';
      empty.textContent='ไม่มีสลิป';
      list.appendChild(empty);
      return;
    }

    items.forEach((it)=>{
      const card=document.createElement('div');
      card.className='card';
      card.id=`slip-${it.id}`;

      const top=document.createElement('div');
      top.className='row between';
      const title=document.createElement('b');
      title.textContent=it.order_no || ('#'+it.order_id);
      const status=document.createElement('span');
      status.textContent=it.slip_status || '-';
      top.append(title,status);
      card.appendChild(top);

      card.appendChild(createMuted(`ยอดโอน: ${formatMoney(it.amount)} | Order: ${formatMoney(it.order_total)}`));
      card.appendChild(createMuted(`โอนเมื่อ: ${it.transfer_at || '-'}`));

      const imgUrl=normalizeImageUrl(it.image_url);
      if(imgUrl){
        const wrap=document.createElement('div');
        wrap.style.marginTop='10px';
        const anchor=document.createElement('a');
        anchor.href=imgUrl;
        anchor.target='_blank';
        const img=document.createElement('img');
        img.className='slip-image';
        img.src=imgUrl;
        img.alt=`slip ${it.id}`;
        anchor.appendChild(img);
        wrap.appendChild(anchor);
        card.appendChild(wrap);
      }

      const actions=document.createElement('div');
      actions.className='actions';
      const note=document.createElement('input');
      note.id=`note-${it.id}`;
      note.type='text';
      note.placeholder='หมายเหตุ (จำเป็นเมื่อ reject)';

      const approve=document.createElement('button');
      approve.className='btn btn-approve';
      approve.textContent='Approve';
      approve.addEventListener('click',()=>approveSlip(it.id));

      const reject=document.createElement('button');
      reject.className='btn btn-reject';
      reject.textContent='Reject';
      reject.addEventListener('click',()=>rejectSlip(it.id));

      actions.append(note,approve,reject);
      card.appendChild(actions);
      list.appendChild(card);
    });
  }catch(e){
    clearNode(list);
    const err=document.createElement('div');
    err.className='error';
    err.textContent=e.message;
    list.appendChild(err);
  }
}

async function approveSlip(id){
  const note=(document.getElementById(`note-${id}`)?.value||'').trim();
  try{
    await api.post(`/api/merchant/payment-slips/${id}/approve`,{note:note||null});
    showToast('Approve สำเร็จ','success');
    load();
  }catch(e){showToast(e.message,'error');}
}

async function rejectSlip(id){
  const note=(document.getElementById(`note-${id}`)?.value||'').trim();
  if(!note){showToast('กรอกหมายเหตุก่อน Reject','error');return;}
  try{
    await api.post(`/api/merchant/payment-slips/${id}/reject`,{note});
    showToast('Reject สำเร็จ','success');
    load();
  }catch(e){showToast(e.message,'error');}
}
</script>
</body>
</html>
