<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS Terminal</title>
  <style>
    :root{--bg:#0b1220;--card:#121a2b;--text:#e7eefc;--muted:#9fb0d0;--ok:#22c55e;--bad:#ef4444;--warn:#f59e0b;--line:#223055}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,"Kanit",sans-serif;background:linear-gradient(180deg,#071026,#0b1220);color:var(--text)}
    .wrap{max-width:560px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;justify-content:space-between;margin:10px 0 14px}
    .title{font-size:18px;font-weight:800}
    .card{background:rgba(18,26,43,.92);border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    .muted{color:var(--muted);font-size:13px}
    input{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--text);padding:12px;font-size:14px;outline:none}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--text);padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer}
    button.primary{background:linear-gradient(90deg,#2563eb,#22c55e);border:0}
    button.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}
    button:disabled{opacity:.5;cursor:not-allowed}
    pre{white-space:pre-wrap;word-break:break-word;margin:10px 0 0;color:#d7e4ff}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04)}
    .badge.ok{border-color:rgba(34,197,94,.35);color:#bbf7d0}
    .badge.bad{border-color:rgba(239,68,68,.35);color:#fecaca}
    .badge.warn{border-color:rgba(245,158,11,.35);color:#fde68a}
    a{color:#93c5fd;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">POS Terminal</div>
      <span id="posStatus" class="badge warn">Checking...</span>
    </div>

    <div class="card">
      <div style="font-weight:700">Coupon Code</div>
      <div class="muted">สแกน QR แล้วเอา “code” มาใส่ (เช่น CP260227-XXXXXX)</div>
      <input id="code" placeholder="วาง/พิมพ์ coupon code" autocomplete="off" />

      <div class="btns">
        <button id="lookupBtn">Lookup</button>
        <button id="camBtn">Scan Camera</button>
        <button id="scanBtn" class="primary">Scan</button>
        <button id="redeemBtn" disabled>Redeem</button>
        <button id="clearBtn" class="danger">Clear</button>
      </div>

      <div class="muted" id="hint" style="margin-top:10px"></div>
      <pre id="out">{}</pre>

    <!-- Camera Scanner Modal -->
    <div id="scanModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:9999;">
      <div style="max-width:560px;margin:0 auto;padding:16px;">
        <div style="background:rgba(18,26,43,.96);border:1px solid #223055;border-radius:16px;padding:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
            <div style="font-weight:800">Scan QR / Barcode</div>
            <button id="closeScanModal" style="border:1px solid #223055;background:rgba(255,255,255,.06);color:#e7eefc;padding:8px 10px;border-radius:12px;font-weight:700;cursor:pointer">ปิด</button>
          </div>
          <div style="color:#9fb0d0;font-size:13px;margin-top:6px">
            ใช้กล้องหลัง (ถ้าเบราว์เซอร์รองรับ). ถ้าใช้ “ปืนยิงบาร์โค้ด” ให้โฟกัสช่อง Code แล้วยิงได้เลย
          </div>
          <div style="margin-top:10px;border-radius:14px;overflow:hidden;border:1px solid #223055;background:#000">
            <video id="scanVideo" playsinline muted autoplay style="width:100%;height:320px;object-fit:cover"></video>
          </div>
          <div id="scanMsg" style="color:#9fb0d0;font-size:13px;margin-top:10px">กำลังเปิดกล้อง...</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
            <button id="toggleTorchBtn" style="border:1px solid #223055;background:rgba(255,255,255,.06);color:#e7eefc;padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer;display:none">ไฟฉาย</button>
          </div>
        </div>
      </div>
    </div>

    </div>

    
    <div class="card" id="devToolsCard" style="display:none">
      <div style="font-weight:800">Dev Tools • ออกคูปองทดสอบ</div>
      <div class="muted">โชว์เฉพาะเมื่อเปิดหน้านี้ด้วย <code>?dev=1</code></div>

      <div style="margin-top:10px;display:grid;gap:10px">
        <div>
          <div class="muted" style="margin-bottom:6px">Buyer Phone</div>
          <input id="devBuyerPhone" placeholder="0811111111" autocomplete="off" />
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px">Buyer Password</div>
          <input id="devBuyerPass" placeholder="123456" type="password" autocomplete="off" />
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px">Product ID</div>
          <input id="devProductId" placeholder="1" autocomplete="off" />
        </div>

        <div class="btns">
          <button id="devLoginBuyerBtn">Login Buyer</button>
          <button id="devIssueBtn" class="primary">Issue Test Coupon</button>
          <button id="devClearBuyerBtn" class="danger">Clear Buyer Token</button>
        </div>

        <div class="muted" id="devBuyerHint"></div>
        <pre id="devOut">{}</pre>
      </div>
    </div>


    <div class="card">
      <div style="font-weight:700">POS Token</div>
      <div class="muted">หากขึ้น revoked ให้กลับไปหน้า Settings เพื่ออัปเดต token</div>
      <div class="btns">
        <a href="./settings.html">ไปหน้า POS Settings</a>
      </div>
    </div>
  </div>

<script>
  const LS_KEY = "pos_token";
  const codeEl = document.getElementById("code");
  const outEl = document.getElementById("out");
  const hintEl = document.getElementById("hint");
  const posStatus = document.getElementById("posStatus");

  const lookupBtn = document.getElementById("lookupBtn");
  const scanBtn = document.getElementById("scanBtn");
  const redeemBtn = document.getElementById("redeemBtn");
  const clearBtn = document.getElementById("clearBtn");

  function token(){ return (localStorage.getItem(LS_KEY) || "").trim(); }
  function show(x){ outEl.textContent = JSON.stringify(x, null, 2); }
  function hint(t){ hintEl.textContent = t || ""; }

  function badge(kind, text){
    posStatus.className = "badge " + (kind || "warn");
    posStatus.textContent = text;
  }

  async function api(path, method="GET", body=null){
    const t = token();
    if(!t) return {status: 401, data:{ok:false,error:"NO_TOKEN"}};

    const res = await fetch(path, {
      method,
      headers: {
        "Accept":"application/json",
        "Content-Type":"application/json",
        "Authorization":"Bearer " + t
      },
      body: body ? JSON.stringify(body) : null
    });

    const data = await res.json().catch(()=>({ok:false,error:"INVALID_JSON"}));
    return {status: res.status, data};
  }

  async function checkPosMe(){
    const {status, data} = await api("/api/pos/me","GET");
    if(status===200 && data.ok){
      if(data.status==="active" && data.can_operate){
        badge("ok","POS Active");
        return true;
      }
      badge("bad","POS Revoked");
      show({http_status:status, ...data});
      return false;
    }
    badge("bad","No Token / Unauth");
    show({http_status:status, ...data});
    return false;
  }

  async function lookup(){
    const c = codeEl.value.trim();
    if(!c) return hint("ใส่ coupon code ก่อน");
    hint("Loading...");
    const {status, data} = await api(`/api/pos/coupons/${encodeURIComponent(c)}`,"GET");
    show({http_status: status, ...data});

    if(status===200 && data.ok){
      const st = data.coupon?.status;
      if(st==="confirmed"){
        redeemBtn.disabled = false;
        hint("confirmed ✅ กด Redeem ได้");
      } else if(st==="pending_confirm"){
        redeemBtn.disabled = true;
        hint("pending_confirm ⏳ รอผู้ซื้อยืนยัน (กด Scan เพื่อขอ confirm)");
      } else if(st==="redeemed"){
        redeemBtn.disabled = true;
        hint("redeemed ✅ ใช้ไปแล้ว");
      } else {
        redeemBtn.disabled = true;
        hint("status=" + st);
      }
      return;
    }

    redeemBtn.disabled = true;
    hint(`Error ${status} ${(data && (data.error||data.message)) || ""}`);
  }

  async function scan(){
    const c = codeEl.value.trim();
    if(!c) return hint("ใส่ coupon code ก่อน");
    hint("Scanning...");
    const {status, data} = await api(`/api/pos/coupons/${encodeURIComponent(c)}/scan`,"POST");
    show({http_status: status, ...data});

    if(status===200 && data.ok){
      if(data.status==="confirmed"){
        redeemBtn.disabled = false;
        hint("confirmed ✅ กด Redeem ได้");
        return;
      }
      if(data.status==="pending_confirm" && data.need_confirm){
        redeemBtn.disabled = true;
        hint("รอยืนยันจากผู้ซื้อ... (กำลัง polling)");
        await pollUntilConfirmed(c);
        return;
      }
      if(data.status==="redeemed"){
        redeemBtn.disabled = true;
        hint("redeemed ✅");
        return;
      }
    }

    if(status===409){
      redeemBtn.disabled = true;
      hint(`Conflict: ${(data.error||data.message)} (status=${data.status||""})`);
      return;
    }

    if(status===401 && data.error==="POS_DEVICE_REVOKED"){
      badge("bad","POS Revoked");
      hint("เครื่องถูก revoke ให้ไปหน้า Settings แล้วใส่ token ใหม่");
      return;
    }

    redeemBtn.disabled = true;
    hint(`Error ${status} ${(data && (data.error||data.message)) || ""}`);
  }

  async function redeem(){
    const c = codeEl.value.trim();
    if(!c) return hint("ใส่ coupon code ก่อน");
    hint("Redeeming...");
    const {status, data} = await api(`/api/pos/coupons/${encodeURIComponent(c)}/redeem`,"POST");
    show({http_status: status, ...data});

    if(status===200 && data.ok){
      redeemBtn.disabled = true;
      hint("redeemed ✅ สำเร็จ");
      return;
    }

    if(status===401 && data.error==="POS_DEVICE_REVOKED"){
      badge("bad","POS Revoked");
      hint("เครื่องถูก revoke ให้ไปหน้า Settings แล้วใส่ token ใหม่");
      return;
    }

    hint(`Error ${status} ${(data && (data.error||data.message)) || ""}`);
  }

  async function pollUntilConfirmed(code){
    const maxMs = 120000;
    const intervalMs = 2000;
    const started = Date.now();

    while(Date.now() - started < maxMs){
      const {status, data} = await api(`/api/pos/coupons/${encodeURIComponent(code)}`,"GET");
      show({http_status: status, ...data});

      if(status===200 && data.ok){
        const st = data.coupon?.status;
        if(st==="confirmed"){
          redeemBtn.disabled = false;
          hint("confirmed ✅ กด Redeem ได้");
          return;
        }
        if(st==="redeemed"){
          redeemBtn.disabled = true;
          hint("redeemed ✅ (ถูกใช้ไปแล้ว)");
          return;
        }
      }

      await new Promise(r=>setTimeout(r, intervalMs));
    }

    hint("หมดเวลารอยืนยัน (timeout) — ให้ลูกค้ากดยืนยันใหม่ แล้วกด Scan อีกครั้ง");
  }

  clearBtn.addEventListener("click", ()=>{
    codeEl.value = "";
    redeemBtn.disabled = true;
    hint("");
    show({});
  });

  lookupBtn.addEventListener("click", lookup);
  scanBtn.addEventListener("click", scan);
  redeemBtn.addEventListener("click", redeem);

  (async ()=>{
    const ok = await checkPosMe();
    if(!ok) return;
    hint("พร้อมใช้งาน ✅");
  })();

  // --- Camera scan (BarcodeDetector) + barcode gun support ---
  const camBtn = document.getElementById("camBtn");
  const scanModal = document.getElementById("scanModal");
  const closeScanModal = document.getElementById("closeScanModal");
  const scanVideo = document.getElementById("scanVideo");
  const scanMsg = document.getElementById("scanMsg");
  const toggleTorchBtn = document.getElementById("toggleTorchBtn");

  let scanStream = null;
  let scanLoopOn = false;
  let barcodeDetector = null;
  let torchOn = false;

  function normalizeScannedValue(raw){
    if(!raw) return "";
    raw = String(raw).trim();
    // ถ้าเป็น URL ให้ดึงส่วนที่เหมือน coupon code
    const m = raw.match(/(CP\d{6}-[A-Z0-9]{4,})/i);
    if(m) return m[1];
    return raw;
  }

  async function openScanModal(){
    if(!navigator.mediaDevices?.getUserMedia){
      scanMsg.textContent = "เบราว์เซอร์นี้ไม่รองรับกล้อง (getUserMedia). ให้ใช้ Chrome หรือใช้เครื่องยิงบาร์โค้ดแทน";
      scanModal.style.display = "block";
      return;
    }

    if("BarcodeDetector" in window){
      try{
        barcodeDetector = new BarcodeDetector({formats:["qr_code","code_128","code_39","ean_13","ean_8","itf"]});
      }catch(e){
        barcodeDetector = null;
      }
    }
    if(!barcodeDetector){
      scanMsg.textContent = "เบราว์เซอร์นี้ไม่รองรับ BarcodeDetector. แนะนำ Chrome/Android หรือใช้เครื่องยิงบาร์โค้ด";
      scanModal.style.display = "block";
      return;
    }

    scanModal.style.display = "block";
    scanMsg.textContent = "กำลังเปิดกล้อง...";
    torchOn = false;
    toggleTorchBtn.style.display = "none";

    try{
      scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } }, audio:false });
      scanVideo.srcObject = scanStream;

      const track = scanStream.getVideoTracks()[0];
      const caps = track.getCapabilities ? track.getCapabilities() : {};
      if(caps && caps.torch){
        toggleTorchBtn.style.display = "inline-block";
        toggleTorchBtn.textContent = "ไฟฉาย";
        toggleTorchBtn.onclick = async ()=>{
          try{
            torchOn = !torchOn;
            await track.applyConstraints({advanced:[{torch: torchOn}]});
            toggleTorchBtn.textContent = torchOn ? "ปิดไฟฉาย" : "ไฟฉาย";
          }catch(e){}
        };
      }

      scanLoopOn = true;
      scanMsg.textContent = "เล็ง QR/Barcode ให้อยู่ในกล้อง...";
      scanLoop();
    }catch(err){
      scanMsg.textContent = "เปิดกล้องไม่สำเร็จ: " + (err?.message || err);
    }
  }

  function closeScan(){
    scanLoopOn = false;
    if(scanStream){
      scanStream.getTracks().forEach(t=>t.stop());
      scanStream = null;
    }
    scanVideo.srcObject = null;
    scanModal.style.display = "none";
  }

  async function scanLoop(){
    if(!scanLoopOn) return;
    try{
      const codes = await barcodeDetector.detect(scanVideo);
      if(codes && codes.length){
        const raw = codes[0].rawValue || "";
        const val = normalizeScannedValue(raw);
        if(val){
          closeScan();
          codeEl.value = val;
          hint("สแกนสำเร็จ ✅ กำลัง Scan...");
          // auto call scan flow
          scan();
          return;
        }
      }
    }catch(e){
      // ignore scanning errors
    }
    requestAnimationFrame(scanLoop);
  }

  if(camBtn) camBtn.addEventListener("click", openScanModal);
  if(closeScanModal) closeScanModal.addEventListener("click", closeScan);

  // barcode gun (keyboard wedge): ยิงแล้วจบด้วย Enter → เรียก Scan ทันที
  codeEl.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      scan();
    }
  });

  // ตั้งโฟกัสไว้เพื่อให้เครื่องยิงบาร์โค้ดพิมพ์เข้าได้ทันที
  setTimeout(()=>{ try{ codeEl.focus(); }catch(e){} }, 300);


  // --- Dev Tools: issue test coupon (buyer login + issue) ---
  const devToolsCard = document.getElementById("devToolsCard");
  const devBuyerPhone = document.getElementById("devBuyerPhone");
  const devBuyerPass = document.getElementById("devBuyerPass");
  const devProductId = document.getElementById("devProductId");
  const devLoginBuyerBtn = document.getElementById("devLoginBuyerBtn");
  const devIssueBtn = document.getElementById("devIssueBtn");
  const devClearBuyerBtn = document.getElementById("devClearBuyerBtn");
  const devBuyerHint = document.getElementById("devBuyerHint");
  const devOut = document.getElementById("devOut");

  const LS_BUYER_TOKEN = "buyer_token_dev";

  function buyerToken(){ return (localStorage.getItem(LS_BUYER_TOKEN) || "").trim(); }
  function setBuyerToken(t){ localStorage.setItem(LS_BUYER_TOKEN, (t||"").trim()); }
  function clearBuyerToken(){ localStorage.removeItem(LS_BUYER_TOKEN); }

  function devShow(x){ devOut.textContent = JSON.stringify(x, null, 2); }
  function devHint(t){ devBuyerHint.textContent = t || ""; }

  async function loginBuyer(){
    const phone = (devBuyerPhone.value || "").trim();
    const pass = (devBuyerPass.value || "").trim();
    if(!phone || !pass){ devHint("ใส่เบอร์และรหัสผ่าน buyer ก่อน"); return; }

    devHint("กำลัง login buyer...");
    const res = await fetch("/api/auth/login", {
      method: "POST",
      headers: {"Accept":"application/json","Content-Type":"application/json"},
      body: JSON.stringify({phone, password: pass})
    });
    const data = await res.json().catch(()=>({ok:false,error:"INVALID_JSON"}));
    devShow({http_status: res.status, ...data});

    if(res.status === 200 && data.token){
      setBuyerToken(data.token);
      devHint("Login buyer สำเร็จ ✅ token ถูกเก็บแล้ว");
    } else {
      devHint("Login buyer ไม่สำเร็จ");
    }
  }

  async function issueTestCoupon(){
    const t = buyerToken();
    if(!t){ devHint("ยังไม่มี buyer token — กด Login Buyer ก่อน"); return; }

    const pid = (devProductId.value || "1").trim() || "1";
    devHint("กำลังออกคูปองทดสอบ...");
    const res = await fetch(`/api/products/${encodeURIComponent(pid)}/coupons/issue`, {
      method: "POST",
      headers: {"Accept":"application/json","Authorization":"Bearer " + t}
    });
    const data = await res.json().catch(()=>({ok:false,error:"INVALID_JSON"}));
    devShow({http_status: res.status, ...data});

    if(res.status === 200 && data.coupon && data.coupon.code){
      const code = data.coupon.code;
      codeEl.value = code;
      devHint("ออกคูปองสำเร็จ ✅ ใส่ code ให้อัตโนมัติแล้ว (กด Scan ได้เลย)");
      // optional: auto lookup
      try{ lookup(); }catch(e){}
    } else {
      devHint("ออกคูปองไม่สำเร็จ");
    }
  }

  function initDevTools(){
    const dev = new URLSearchParams(location.search).get("dev") === "1";
    if(devToolsCard) devToolsCard.style.display = dev ? "block" : "none";
    if(!dev) return;

    // default values for test
    if(devBuyerPhone && !devBuyerPhone.value) devBuyerPhone.value = "0811111111";
    if(devBuyerPass && !devBuyerPass.value) devBuyerPass.value = "123456";
    if(devProductId && !devProductId.value) devProductId.value = "1";

    if(devLoginBuyerBtn) devLoginBuyerBtn.addEventListener("click", loginBuyer);
    if(devIssueBtn) devIssueBtn.addEventListener("click", issueTestCoupon);
    if(devClearBuyerBtn) devClearBuyerBtn.addEventListener("click", ()=>{
      clearBuyerToken();
      devHint("ล้าง buyer token แล้ว");
      devShow({});
    });

    devHint(buyerToken() ? "มี buyer token แล้ว ✅ (กด Issue ได้เลย)" : "ยังไม่มี buyer token (กด Login Buyer)");
  }

  initDevTools();

</script>
</body>
</html>
