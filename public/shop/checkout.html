<!doctype html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>Checkout</title><link rel='stylesheet' href='assets/shop.css'></head><body>
<div class='app'><div id='header'></div><div class='card'><h3>ที่อยู่</h3><select id='addressSelect'></select></div><div class='card'><h4>เพิ่มที่อยู่ใหม่</h4><input id='receiver_name' class='input' placeholder='ชื่อผู้รับ'><input id='receiver_phone' class='input' placeholder='โทร'><input id='address_line1' class='input' placeholder='ที่อยู่'><button class='btn btn-ghost' id='addAddress'>บันทึกที่อยู่</button></div><div id='summary' class='card'></div><button id='createOrder' class='btn btn-primary' style='width:100%'>ยืนยันสั่งซื้อ</button></div><div id='toast' class='toast'></div><div id='bottomNav'></div>
<script src='assets/api.js'></script><script src='assets/cart.js'></script><script src='assets/app.js'></script><script>
renderHeader('Checkout');renderBottomNav('cart');if(requireAuth())init();
async function init(){renderSummary();await loadAddresses();addAddress.onclick=createAddress;createOrder.onclick=submitOrder}
function renderSummary(){const c=cartStore.calcTotals();summary.innerHTML=`<h3>สรุปรายการ</h3>${c.items.map(i=>`<div class='row between'><span>${i.name} x ${i.qty}</span><b>${formatMoney(i.price*i.qty)}</b></div>`).join('')}<hr><div class='row between'><b>Total</b><b>${formatMoney(c.total)}</b></div>`}
async function loadAddresses(){try{const d=await api.get('/api/me/addresses');addressSelect.innerHTML=(d.items||[]).map(a=>`<option value='${a.id}'>${a.receiver_name} - ${a.address_line1}</option>`).join('')}catch(e){showToast(e.message,'error')}}
async function createAddress(){try{await api.post('/api/me/addresses',{receiver_name:receiver_name.value,receiver_phone:receiver_phone.value,address_line1:address_line1.value});showToast('เพิ่มที่อยู่แล้ว','success');loadAddresses()}catch(e){showToast(e.message,'error')}}
async function submitOrder(){const c=cartStore.calcTotals();if(!c.items.length)return showToast('ตะกร้าว่าง','error');try{const d=await api.post('/api/orders',{address_id:+addressSelect.value,items:c.items.map(i=>({product_id:i.product_id,variant_id:i.variant_id,qty:i.qty}))});cartStore.clearCart();location.href=`order.html?id=${d.item.id}`}catch(e){showToast(e.message,'error')}}
</script></body></html>
